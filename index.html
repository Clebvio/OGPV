<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solar Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { margin: 0; padding: 0; height: 100%; }
    #progressContainer {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 4px;
      z-index: 1001;
    }
    #hoverValue {
      position: absolute;
      pointer-events: none;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 3px 8px;
      font-size: 14px;
      border-radius: 4px;
      z-index: 1002;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="progressContainer">Loading‚Ä¶</div>
  <div id="hoverValue" style="display: none;"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>

  <script>
    const map = L.map('map', { preferCanvas: true }).setView([51, -112], 5);

    // Base map (dark gray with reference)
    const baseMap = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}',
      { attribution: "ESRI", maxZoom: 16 }
    ).addTo(map);

    const labelLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 16, zIndex: 1000 }
    ).addTo(map);

    const progress = document.getElementById("progressContainer");
    const hoverValue = document.getElementById("hoverValue");

    const layers = {};
    GeoRasterLayer.debugLevel = 1;

    async function loadGeoTIFF({ name, url, valueMin, valueMax, colorScale, isGradient }) {
      console.log(`üõ∞Ô∏è Attempting to load ${name} from ${url}`);
      progress.innerHTML = `<strong>${name}</strong>: <progress value="0" max="100" id="bar"></progress>`;
      progress.style.display = "block";

      const response = await fetch(url);
      const total = parseInt(response.headers.get("content-length") || "0", 10);
      const reader = response.body.getReader();
      let received = 0;
      const chunks = [];

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
        if (total) {
          document.getElementById("bar").value = Math.floor((received / total) * 100);
        }
      }

      const arrayBuffer = await new Blob(chunks).arrayBuffer();
      const georaster = await parseGeoraster(arrayBuffer);

      const layer = new GeoRasterLayer({
        georaster,
        resolution: null, // Full resolution
        opacity: 0.85,
        zIndex: 5,
        pixelValuesToColorFn: values => {
          const v = values[0];
          if (v == null || v < valueMin || v > valueMax) return null;
          return typeof colorScale === "function" ? colorScale(v) : colorScale;
        }
      });

      layers[name] = layer;
      map.addLayer(layer);

      if (name === "OGIRRI") {
        try {
          map.fitBounds(layer.getBounds());
        } catch (err) {
          console.warn("‚ö†Ô∏è Couldn't zoom to bounds for OGIRRI", err);
        }
      }

      layer.on("click", (e) => {
        const latlng = e.latlng;
        if (layer.getValueAtLatLng) {
          layer.getValueAtLatLng(latlng.lat, latlng.lng).then(val => {
            alert(`${name}: ${val?.[0]?.toFixed(2) ?? "No data"}`);
          });
        }
      });

      map.on("mousemove", e => {
        if (!map.hasLayer(layer)) return;
        if (typeof layer.getValueAtLatLng === "function") {
          layer.getValueAtLatLng(e.latlng.lat, e.latlng.lng).then(val => {
            if (val && val[0] != null) {
              hoverValue.style.display = "block";
              hoverValue.innerHTML = `${name}: ${val[0].toFixed(2)}`;
              hoverValue.style.left = `${e.originalEvent.clientX + 12}px`;
              hoverValue.style.top = `${e.originalEvent.clientY + 12}px`;
            } else {
              hoverValue.style.display = "none";
            }
          });
        }
      });

      console.log(`‚úÖ ${name} loaded`);
      progress.style.display = "none";
    }

    // Load OGIRRI (gradient)
    loadGeoTIFF({
      name: "OGIRRI",
      url: "https://clebvio.github.io/OGPV/OGIRRI.tif",
      valueMin: 800,
      valueMax: 1680,
      isGradient: true,
      colorScale: chroma.scale([
        "#ffffff", "#191919", "#4e4e4e", "#6a6a6a",
        "#7cd2e1", "#93e9e7", "#c7f7c6", "#f8ff8a"
      ]).domain([
        800, 923.07, 1170.19, 1279.48,
        1425.19, 1490.18, 1588.63, 1619.15
      ]).mode("lrgb")
    });

    // Load OGTILT (stepped)
    loadGeoTIFF({
      name: "OGTILT",
      url: "https://clebvio.github.io/OGPV/OGTILT.tif",
      valueMin: 29,
      valueMax: 55,
      isGradient: false,
      colorScale: val => {
        if (val < 32) return "#30123b";
        if (val < 34) return "#4143a7";
        if (val < 36) return "#3e9cfe";
        if (val < 38) return "#21c6e1";
        if (val < 40) return "#48f882";
        if (val < 42) return "#bbf534";
        if (val < 44) return "#fbb938";
        if (val < 46) return "#ef5911";
        if (val < 48) return "#d43305";
        return "#7a0403";
      }
    });
  </script>
</body>
</html>
