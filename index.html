<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Solar Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map {
      height: 100%; margin: 0; padding: 0;
    }
    .info {
      position: absolute;
      bottom: 20px;
      left: 10px;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background: white;
      padding: 10px;
      font-size: 12px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info" id="info">Hover over the map to see values…</div>
  <div class="legend" id="legend">Legend will load with data layer.</div>

  <!-- Leaflet & Plugins -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

  <script>
    const OGIRRI_MIN = 800;
    const OGIRRI_MAX = 1600;

    const map = L.map('map').setView([51, -96], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CartoDB'
    }).addTo(map);

    const info = document.getElementById('info');
    const legend = document.getElementById('legend');

    L.Control.geocoder({ defaultMarkGeocode: true })
      .on('markgeocode', function(e) {
        map.setView(e.geocode.center, 12);
      }).addTo(map);

    function updateLegend(title, gradientColors) {
      legend.innerHTML = `
        <div style="margin-bottom: 4px;"><strong>${title}</strong></div>
        <div style="
          height: 12px;
          width: 180px;
          background: linear-gradient(to right, ${gradientColors.join(',')});
          border: 1px solid #aaa;
          margin-bottom: 4px;
        "></div>
        <div style="display: flex; justify-content: space-between; font-size: 10px;">
          <span>${OGIRRI_MIN}</span><span>${OGIRRI_MAX}</span>
        </div>
      `;
    }

    const layers = {};
    const overlayControl = L.control.layers(null, {}).addTo(map);

    function loadGeoTIFFLayer({ name, url, colorScale, ranges, valueMin, valueMax }) {
      console.log(`Attempting to load ${name}...`);
      fetch(url)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status} for ${name}`);
          return r.arrayBuffer();
        })
        .then(parseGeoraster)
        .then(georaster => {
          const layer = new GeoRasterLayer({
            georaster,
            opacity: 0.85,
            resolution: 256,
            pixelValuesToColorFn: values => {
              const v = values[0];
              if (v == null || v < valueMin || v > valueMax) return null;
              return colorScale(v);
            }
          });
          layer._legend = ranges;
          layers[name] = layer;
          overlayControl.addOverlay(layer, name);

          if (name === "OGIRRI" && !map.hasLayer(layer)) {
            map.addLayer(layer);
            updateLegend(name, [
              "#303030", "#4e6b6e", "#6aa6ad", "#90d5dc",
              "#b2ebf2", "#d0f3de", "#f1f8c0", "#fffbc1"
            ]);
          }

          map.on('mousemove', function(e) {
            if (!map.hasLayer(layer)) return;
            if (typeof layer.getValueAtLatLng === 'function') {
              layer.getValueAtLatLng(e.latlng.lat, e.latlng.lng).then(val => {
                if (val && val[0] != null) {
                  info.innerHTML = `${name}: <strong>${val[0].toFixed(2)}</strong>`;
                } else {
                  info.innerHTML = "No data here…";
                }
              });
            }
          });
        }).catch(err => console.error(`❌ Failed to load ${name}:`, err));
    }

    loadGeoTIFFLayer({
      name: "OGIRRI",
      url: "https://clebvio.github.io/OGPV/OGIRRI.tif",
      valueMin: 800,
      valueMax: 1600,
      colorScale: val => {
        if (val < 923) return "#303030";
        if (val < 1170) return "#4e6b6e";
        if (val < 1279) return "#6aa6ad";
        if (val < 1425) return "#90d5dc";
        if (val < 1490) return "#b2ebf2";
        if (val < 1588) return "#d0f3de";
        return "#fffbc1";
      },
      ranges: []
    });

    loadGeoTIFFLayer({
      name: "OGTILT",
      url: "https://clebvio.github.io/OGPV/OGTILT.tif",
      valueMin: 29,
      valueMax: 55,
      colorScale: val => {
        if (val < 32) return "#30123b";
        if (val < 34) return "#4143a7";
        if (val < 36) return "#3e9cfe";
        if (val < 38) return "#21c6e1";
        if (val < 40) return "#48f882";
        if (val < 42) return "#bbf534";
        if (val < 44) return "#fbb938";
        if (val < 46) return "#ef5911";
        if (val < 48) return "#d43305";
        return "#7a0403";
      },
      ranges: [
        { label: "≤ 32", color: "#30123b" },
        { label: "≤ 34", color: "#4143a7" },
        { label: "≤ 36", color: "#3e9cfe" },
        { label: "≤ 38", color: "#21c6e1" },
        { label: "≤ 40", color: "#48f882" },
        { label: "≤ 42", color: "#bbf534" },
        { label: "≤ 44", color: "#fbb938" },
        { label: "≤ 46", color: "#ef5911" },
        { label: "> 48", color: "#7a0403" }
      ]
    });

    map.on('overlayadd', function (e) {
      const layer = layers[e.name];
      if (e.name === "OGIRRI") {
        updateLegend("OGIRRI", [
          "#303030", "#4e6b6e", "#6aa6ad", "#90d5dc",
          "#b2ebf2", "#d0f3de", "#f1f8c0", "#fffbc1"
        ]);
      } else if (layer && layer._legend) {
        legend.innerHTML = `<strong>${e.name}</strong><br>` + layer._legend.map(r => `
          <div style="margin-bottom: 3px">
            <span style="display:inline-block;width:16px;height:12px;background:${r.color};margin-right:6px;"></span>${r.label}
          </div>`).join('');
      }
    });
  </script>
</body>
</html>
