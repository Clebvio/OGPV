<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Solar Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; background: #1c1c1c; }
    .info {
      position: absolute;
      bottom: 20px;
      left: 10px;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background: white;
      padding: 10px;
      font-size: 12px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .legend-gradient {
      height: 12px;
      width: 200px;
      background: linear-gradient(to right, #191919, #4e4e4e, #6a6a6a, #7cd2e1, #93e9e7, #c7f7c6, #f8ff8a);
      margin-bottom: 5px;
    }
    .legend-labels {
      display: flex;
      justify-content: space-between;
    }
    .legend-color {
      width: 16px;
      height: 12px;
      margin-right: 6px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info" id="info">Hover over the map to see valuesâ€¦</div>
  <div class="legend" id="legend">Legend loading...</div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
  <script src="https://unpkg.com/chroma-js@2.1.0/chroma.min.js"></script>

  <script>
    const map = L.map('map', {
      preferCanvas: true
    }).setView([51, -96], 4);

    // Dark basemap with roads/borders/labels
    const basemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CARTO</a>'
    }).addTo(map);

    const info = document.getElementById('info');
    const legend = document.getElementById('legend');

    L.Control.geocoder({
      defaultMarkGeocode: true
    }).on('markgeocode', function(e) {
      map.setView(e.geocode.center, 12);
    }).addTo(map);

    const layers = {};
    const overlayControl = L.control.layers(null, {}).addTo(map);

    function updateLegend(layerName, type, data) {
      if (type === "gradient") {
        legend.innerHTML = `
          <strong>${layerName}</strong>
          <div class="legend-gradient"></div>
          <div class="legend-labels">
            <span>800</span><span>1600</span>
          </div>
        `;
      } else {
        legend.innerHTML = `<strong>${layerName}</strong><br>` + data.map(r => `
          <div><span class="legend-color" style="background:${r.color}"></span>${r.label}</div>
        `).join('');
      }
    }

    function loadGeoTIFFLayer({ name, url, min, max, colorFn, legendType, legendData }) {
      console.log(`ðŸ›°ï¸ Attempting to load ${name}...`);

      fetch(url)
        .then(r => r.arrayBuffer())
        .then(parseGeoraster)
        .then(georaster => {
          const layer = new GeoRasterLayer({
            georaster,
            opacity: 0.85,
            resolution: 128,
            pixelValuesToColorFn: values => {
              const v = values[0];
              if (v == null || v < min || v > max) return null;
              return colorFn(v);
            }
          });

          layer._legend = legendData;
          layer._legendType = legendType;
          layers[name] = layer;
          overlayControl.addOverlay(layer, name);

          if (Object.keys(layers).length === 1) {
            map.addLayer(layer);
            updateLegend(name, legendType, legendData);
          }

          console.log(`âœ… Registered: ${name}`);
        })
        .catch(err => console.error(`âŒ ${name} load failed:`, err));
    }

    // OGIRRI (Gradient)
    const gradientScale = chroma.scale(['#191919', '#4e4e4e', '#6a6a6a', '#7cd2e1', '#93e9e7', '#c7f7c6', '#f8ff8a']).domain([800, 1600]);
    loadGeoTIFFLayer({
      name: "OGIRRI",
      url: "https://clebvio.github.io/OGPV/OGIRRI.tif",
      min: 800,
      max: 1600,
      colorFn: val => gradientScale(val).hex(),
      legendType: "gradient",
      legendData: null
    });

    // OGTILT (Discrete)
    const ogtiltRanges = [
      { value: 30.625, color: "rgb(48,18,59)", label: "â‰¤ 32" },
      { value: 32.25, color: "rgb(65,67,167)", label: "â‰¤ 34" },
      { value: 33.875, color: "rgb(71,113,233)", label: "â‰¤ 36" },
      { value: 35.5, color: "rgb(62,156,254)", label: "â‰¤ 38" },
      { value: 37.125, color: "rgb(33,198,225)", label: "â‰¤ 40" },
      { value: 38.75, color: "rgb(27,229,181)", label: "â‰¤ 42" },
      { value: 40.375, color: "rgb(72,248,130)", label: "â‰¤ 44" },
      { value: 42, color: "rgb(137,255,77)", label: "â‰¤ 46" },
      { value: 43.625, color: "rgb(187,245,52)", label: "â‰¤ 48" },
      { value: 45.25, color: "rgb(226,220,56)", label: "> 48" }
    ];
    loadGeoTIFFLayer({
      name: "OGTILT",
      url: "https://clebvio.github.io/OGPV/OGTILT.tif",
      min: 29,
      max: 55,
      colorFn: val => {
        for (const r of ogtiltRanges) {
          if (val <= r.value) return r.color;
        }
        return "rgb(122,4,3)";
      },
      legendType: "discrete",
      legendData: ogtiltRanges
    });

    map.on("overlayadd", function(e) {
      const layer = layers[e.name];
      if (layer) {
        updateLegend(e.name, layer._legendType, layer._legend);
      }
    });

    map.on("mousemove", function(e) {
      Object.entries(layers).forEach(([name, layer]) => {
        if (map.hasLayer(layer) && typeof layer.getValueAtLatLng === "function") {
          layer.getValueAtLatLng(e.latlng.lat, e.latlng.lng).then(val => {
            if (val && val[0] != null) {
              info.innerHTML = `${name}: <strong>${val[0].toFixed(2)}</strong>`;
            } else {
              info.innerHTML = "No data hereâ€¦";
            }
          });
        }
      });
    });
  </script>
</body>
</html>
