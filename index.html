<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Solar Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .info {
      position: absolute;
      bottom: 20px;
      left: 10px;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background: white;
      padding: 10px;
      font-size: 12px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .legend-color {
      width: 20px;
      height: 12px;
      display: inline-block;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info" id="info">Hover over the map to see values…</div>
  <div class="legend" id="legend"></div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Address search -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <!-- GeoRaster support -->
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

  <script>
    const map = L.map('map').setView([51, -96], 4);

    // Base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const info = document.getElementById('info');
    const legend = document.getElementById('legend');

    // Address search bar
    L.Control.geocoder({ defaultMarkGeocode: true })
      .on('markgeocode', function(e) {
        map.setView(e.geocode.center, 12);
      }).addTo(map);

    const tiffLayers = {};

    // Color scale for OGIRRI
    function getColorForOGIRRI(value) {
      if (value <= 923) return "#191919";
      if (value <= 1170) return "#4e4e4e";
      if (value <= 1279) return "#6a6a6a";
      if (value <= 1425) return "#7cd2e1";
      if (value <= 1490) return "#93e9e7";
      if (value <= 1588) return "#c7f7c6";
      return "#f8ff8a";
    }

    // Color scale for OGTILT
    function getColorForOGTILT(value) {
      if (value <= 32) return "#30123b";
      if (value <= 34) return "#4143a7";
      if (value <= 36) return "#3e9cfe";
      if (value <= 38) return "#21c6e1";
      if (value <= 40) return "#48f882";
      if (value <= 42) return "#bbf534";
      if (value <= 44) return "#fbb938";
      if (value <= 46) return "#ef5911";
      if (value <= 48) return "#d43305";
      return "#7a0403";
    }

    function loadGeoTiff(url, id, colorFn, legendSteps) {
      fetch(url)
        .then(res => res.arrayBuffer())
        .then(arrayBuffer => parseGeoraster(arrayBuffer))
        .then(georaster => {
          const layer = new GeoRasterLayer({
            georaster,
            opacity: 0.8,
            pixelValuesToColorFn: (values) => {
              const val = values[0];
              return val ? colorFn(val) : null;
            },
            resolution: 256
          });

          tiffLayers[id] = layer;
          map.addLayer(layer);
          map.fitBounds(layer.getBounds());

          // Hover readout
          map.on('mousemove', function(e) {
            const { lat, lng } = e.latlng;
            layer.getValueAtLatLng(lat, lng).then(val => {
              if (val && val[0] !== null) {
                info.innerHTML = `${id} value: <strong>${val[0].toFixed(2)}</strong>`;
              } else {
                info.innerHTML = "No data here…";
              }
            });
          });

          // Legend
          legend.innerHTML = legendSteps.map(s => `
            <div><span class="legend-color" style="background:${s.color}"></span>${s.label}</div>
          `).join('');
        });
    }

    // Add layer switcher
    const baseMaps = {};
    const overlayMaps = {
      "OGIRRI": L.layerGroup(),
      "OGTILT": L.layerGroup()
    };

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    // Load OGIRRI
    loadGeoTiff(
      'https://clebvio.github.io/OGPV/OGIRRI.tif',
      'OGIRRI',
      getColorForOGIRRI,
      [
        { label: "≤ 923", color: "#191919" },
        { label: "≤ 1170", color: "#4e4e4e" },
        { label: "≤ 1279", color: "#6a6a6a" },
        { label: "≤ 1425", color: "#7cd2e1" },
        { label: "≤ 1490", color: "#93e9e7" },
        { label: "≤ 1588", color: "#c7f7c6" },
        { label: "> 1588", color: "#f8ff8a" }
      ]
    );

    // Load OGTILT
    loadGeoTiff(
      'https://clebvio.github.io/OGPV/OGTILT.tif',
      'OGTILT',
      getColorForOGTILT,
      [
        { label: "≤ 32", color: "#30123b" },
        { label: "≤ 34", color: "#4143a7" },
        { label: "≤ 36", color: "#3e9cfe" },
        { label: "≤ 38", color: "#21c6e1" },
        { label: "≤ 40", color: "#48f882" },
        { label: "≤ 42", color: "#bbf534" },
        { label: "≤ 44", color: "#fbb938" },
        { label: "≤ 46", color: "#ef5911" },
        { label: "> 48", color: "#7a0403" }
      ]
    );
  </script>
</body>
</html>
