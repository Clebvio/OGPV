<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Solar Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .info {
      position: absolute;
      bottom: 20px;
      left: 10px;
      background: #222;
      color: #eee;
      padding: 8px 14px;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background: #222;
      color: #eee;
      padding: 10px;
      font-size: 12px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .legend-color {
      width: 20px;
      height: 12px;
      display: inline-block;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info" id="info">Hover over the map to see valuesâ€¦</div>
  <div class="legend" id="legend">Legend will load with data layer.</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

  <script>
    const map = L.map('map').setView([51, -96], 4);

    // Dark basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">Carto</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // Overlay with labels
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    const info = document.getElementById('info');
    const legend = document.getElementById('legend');
    const layers = {};
    const overlayControl = L.control.layers(null, {}).addTo(map);

    // Address search
    L.Control.geocoder({ defaultMarkGeocode: true })
      .on('markgeocode', function (e) {
        map.setView(e.geocode.center, 12);
      }).addTo(map);

    function updateLegend(title, ranges) {
      legend.innerHTML = `<strong>${title}</strong><br>` + ranges.map(r => `
        <div><span class="legend-color" style="background:${r.color}"></span>${r.label}</div>
      `).join('');
    }

    function loadGeoTIFFLayer({ name, url, colorScale, ranges }) {
      fetch(url)
        .then(r => r.arrayBuffer())
        .then(parseGeoraster)
        .then(georaster => {
          const layer = new GeoRasterLayer({
            georaster,
            opacity: 0.85,
            resolution: 256,
            pixelValuesToColorFn: values => {
              const v = values[0];
              if (v == null) return null;
              return colorScale(v);
            }
          });

          layer._legend = ranges;
          layers[name] = layer;
          overlayControl.addOverlay(layer, name);

          // Show first layer by default
          if (Object.keys(layers).length === 1) {
            map.addLayer(layer);
            updateLegend(name, ranges);
          }

          map.on('mousemove', function (e) {
            Object.entries(layers).forEach(([layerName, layerObj]) => {
              if (!map.hasLayer(layerObj)) return;
              if (typeof layerObj.getValueAtLatLng === 'function') {
                layerObj.getValueAtLatLng(e.latlng.lat, e.latlng.lng).then(val => {
                  if (val && val[0] != null) {
                    info.innerHTML = `${layerName}: <strong>${val[0].toFixed(2)}</strong>`;
                  } else {
                    info.innerHTML = "No data hereâ€¦";
                  }
                });
              }
            });
          });
        })
        .catch(err => {
          console.error(`Failed to load layer "${name}" from ${url}`, err);
        });
    }

    // ðŸ” Reversed color scale for OGTILT
    loadGeoTIFFLayer({
      name: "OGTILT",
      url: "https://clebvio.github.io/OGPV/OGTILT.tif",
      colorScale: val => {
        if (val <= 30.625) return "rgba(122,4,3,1)";
        if (val <= 32.25)  return "rgba(172,23,1,1)";
        if (val <= 33.875) return "rgba(212,51,5,1)";
        if (val <= 35.5)   return "rgba(239,89,17,1)";
        if (val <= 37.125) return "rgba(253,139,38,1)";
        if (val <= 38.75)  return "rgba(251,185,56,1)";
        if (val <= 40.375) return "rgba(226,220,56,1)";
        if (val <= 42)     return "rgba(187,245,52,1)";
        if (val <= 43.625) return "rgba(137,255,77,1)";
        if (val <= 45.25)  return "rgba(72,248,130,1)";
        if (val <= 46.875) return "rgba(27,229,181,1)";
        if (val <= 48.5)   return "rgba(33,198,225,1)";
        if (val <= 50.125) return "rgba(62,156,254,1)";
        if (val <= 51.75)  return "rgba(71,113,233,1)";
        if (val <= 53.375) return "rgba(65,67,167,1)";
        return "rgba(48,18,59,1)";
      },
      ranges: [
        { label: "â‰¤ 31", color: "rgba(122,4,3,1)" },
        { label: "31â€“32", color: "rgba(172,23,1,1)" },
        { label: "32â€“34", color: "rgba(212,51,5,1)" },
        { label: "34â€“36", color: "rgba(239,89,17,1)" },
        { label: "36â€“37", color: "rgba(253,139,38,1)" },
        { label: "37â€“39", color: "rgba(251,185,56,1)" },
        { label: "39â€“40", color: "rgba(226,220,56,1)" },
        { label: "40â€“42", color: "rgba(187,245,52,1)" },
        { label: "42â€“44", color: "rgba(137,255,77,1)" },
        { label: "44â€“45", color: "rgba(72,248,130,1)" },
        { label: "45â€“47", color: "rgba(27,229,181,1)" },
        { label: "47â€“49", color: "rgba(33,198,225,1)" },
        { label: "49â€“50", color: "rgba(62,156,254,1)" },
        { label: "50â€“52", color: "rgba(71,113,233,1)" },
        { label: "52â€“53", color: "rgba(65,67,167,1)" },
        { label: "> 53", color: "rgba(48,18,59,1)" }
      ]
    });

    // âœ… OGIRRI with actual value ranges
    loadGeoTIFFLayer({
      name: "OGIRRI",
      url: "https://clebvio.github.io/OGPV/OGIRRI.tif",
      colorScale: val => {
        if (val <= 800) return "rgba(255,255,255,1)";
        if (val <= 923.07) return "rgba(25,25,25,1)";
        if (val <= 1170.19) return "rgba(78,78,78,1)";
        if (val <= 1279.48) return "rgba(106,106,106,1)";
        if (val <= 1425.19) return "rgba(124,210,225,1)";
        if (val <= 1490.18) return "rgba(147,233,231,1)";
        if (val <= 1588.63) return "rgba(199,247,198,1)";
        return "rgba(248,255,138,1)";
      },
      ranges: [
        { label: "â‰¤ 800", color: "rgba(255,255,255,1)" },
        { label: "â‰¤ 923", color: "rgba(25,25,25,1)" },
        { label: "â‰¤ 1170", color: "rgba(78,78,78,1)" },
        { label: "â‰¤ 1279", color: "rgba(106,106,106,1)" },
        { label: "â‰¤ 1425", color: "rgba(124,210,225,1)" },
        { label: "â‰¤ 1490", color: "rgba(147,233,231,1)" },
        { label: "â‰¤ 1588", color: "rgba(199,247,198,1)" },
        { label: "> 1588", color: "rgba(248,255,138,1)" }
      ]
    });

    map.on('overlayadd', function (e) {
      const layer = layers[e.name];
      if (layer && layer._legend) updateLegend(e.name, layer._legend);
    });
  </script>
</body>
</html>
