<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solar Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
      cursor: crosshair;
    }
    .info-box {
      position: absolute;
      pointer-events: none;
      background: rgba(0, 0, 0, 0.75);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      z-index: 1001;
    }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background: white;
      padding: 10px;
      font-size: 12px;
      border-radius: 4px;
      line-height: 1.4;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }
    .legend-color {
      width: 16px;
      height: 12px;
      margin-right: 6px;
    }
    #progressContainer {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 4px;
      display: none;
      z-index: 1001;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info-box" id="cursorInfo" style="display: none;"></div>
  <div class="legend" id="legend">Legend will load with data layer.</div>
  <div id="progressContainer">Loadingâ€¦</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>

  <script>
    const map = L.map('map', {
      preferCanvas: true
    }).setView([51, -112.5], 5);

    // Esri dark gray basemap with city/road labels
    const base = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}');
    const labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}', {
      zIndex: 1000
    });
    base.addTo(map);
    labels.addTo(map);

    const legend = document.getElementById("legend");
    const cursorInfo = document.getElementById("cursorInfo");
    const progress = document.getElementById("progressContainer");
    const layers = {};

    const overlayControl = L.control.layers(null, null, { collapsed: false }).addTo(map);

    function updateLegend(title, ranges, isGradient = false) {
      if (isGradient) {
        legend.innerHTML = `
          <strong>${title}</strong><br>
          <div style="background: linear-gradient(to right, #ffffff, #191919, #4e4e4e, #6a6a6a, #7cd2e1, #93e9e7, #c7f7c6, #f8ff8a);
                      height: 15px; width: 150px; margin-bottom: 5px; border: 1px solid #ccc;"></div>
          <div style="display: flex; justify-content: space-between;">
            <span>800</span><span>1600</span>
          </div>`;
      } else {
        legend.innerHTML = `<strong>${title}</strong><br>` + ranges.map(r => `
          <div class="legend-item">
            <div class="legend-color" style="background:${r.color}"></div>${r.label}
          </div>`).join('');
      }
    }

    async function loadGeoTIFFLayer({ name, url, valueMin, valueMax, colorScale, ranges, isGradient }) {
      console.log(`ðŸ›°ï¸ Starting download: ${name}`);
      progress.innerText = `Downloading ${name}â€¦ 0%`;
      progress.style.display = "block";

      const xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.responseType = "arraybuffer";

      xhr.onprogress = function (evt) {
        if (evt.lengthComputable) {
          const percent = Math.round((evt.loaded / evt.total) * 100);
          progress.innerText = `Downloading ${name}â€¦ ${percent}%`;
        }
      };

      xhr.onload = async function () {
        const buffer = xhr.response;
        const georaster = await parseGeoraster(buffer);
        console.log(`ðŸ“¦ ${name} raster:`, georaster);

        const layer = new GeoRasterLayer({
          georaster,
          resolution: 64, // High-res for clarity
          opacity: 0.85,
          pixelValuesToColorFn: values => {
            const val = values[0];
            if (val == null || val < valueMin || val > valueMax) return null;
            return typeof colorScale === "function" ? colorScale(val) : colorScale;
          },
          zIndex: 10
        });

        layer._legend = ranges;
        layer._isGradient = isGradient;
        layers[name] = layer;
        overlayControl.addOverlay(layer, name);

        if (name === "OGIRRI") {
          map.addLayer(layer);
          updateLegend(name, ranges, isGradient);
        }

        console.log(`âœ… Registered: ${name}`);
        progress.style.display = "none";
      };

      xhr.onerror = () => {
        console.error(`âŒ Failed to load ${name}`);
        progress.style.display = "none";
      };

      xhr.send();
    }

    function showHoverValue(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      const activeLayer = Object.values(layers).find(l => map.hasLayer(l));
      if (!activeLayer?.getValueAtLatLng) return;

      activeLayer.getValueAtLatLng(lat, lng).then(val => {
        if (val && val[0] != null) {
          cursorInfo.innerHTML = `${activeLayer.options.name}: <strong>${val[0].toFixed(2)}</strong>`;
          cursorInfo.style.left = e.originalEvent.pageX + 10 + "px";
          cursorInfo.style.top = e.originalEvent.pageY + 10 + "px";
          cursorInfo.style.display = "block";
        } else {
          cursorInfo.style.display = "none";
        }
      });
    }

    function showBothValuesAt(latlng) {
      Promise.all(
        Object.entries(layers).map(([name, layer]) => {
          if (layer.getValueAtLatLng)
            return layer.getValueAtLatLng(latlng.lat, latlng.lng)
              .then(val => `${name}: ${val?.[0]?.toFixed(2) ?? "No data"}`);
          return Promise.resolve(`${name}: Not loaded`);
        })
      ).then(results => {
        const html = results.join("<br>");
        L.popup()
          .setLatLng(latlng)
          .setContent(html)
          .openOn(map);
      });
    }

    map.on("mousemove", showHoverValue);
    map.on("click", e => showBothValuesAt(e.latlng));

    L.Control.geocoder({ defaultMarkGeocode: true }).on("markgeocode", function(e) {
      map.setView(e.geocode.center, 11);
      showBothValuesAt(e.geocode.center);
    }).addTo(map);

    // OGIRRI (gradient)
    loadGeoTIFFLayer({
      name: "OGIRRI",
      url: "https://clebvio.github.io/OGPV/OGIRRI.tif",
      valueMin: 800,
      valueMax: 1680,
      isGradient: true,
      colorScale: chroma.scale([
        "#ffffff", "#191919", "#4e4e4e", "#6a6a6a",
        "#7cd2e1", "#93e9e7", "#c7f7c6", "#f8ff8a"
      ]).domain([
        800, 923.07, 1170.19, 1279.48,
        1425.19, 1490.18, 1588.63, 1619.15
      ]).mode("lrgb"),
      ranges: [] // Gradient legend
    });

    // OGTILT (stepped)
    loadGeoTIFFLayer({
      name: "OGTILT",
      url: "https://clebvio.github.io/OGPV/OGTILT.tif",
      valueMin: 29,
      valueMax: 55,
      isGradient: false,
      colorScale: val => {
        if (val < 32) return "#30123b";
        if (val < 34) return "#4143a7";
        if (val < 36) return "#3e9cfe";
        if (val < 38) return "#21c6e1";
        if (val < 40) return "#48f882";
        if (val < 42) return "#bbf534";
        if (val < 44) return "#fbb938";
        if (val < 46) return "#ef5911";
        if (val < 48) return "#d43305";
        return "#7a0403";
      },
      ranges: [
        { label: "â‰¤ 32", color: "#30123b" },
        { label: "â‰¤ 34", color: "#4143a7" },
        { label: "â‰¤ 36", color: "#3e9cfe" },
        { label: "â‰¤ 38", color: "#21c6e1" },
        { label: "â‰¤ 40", color: "#48f882" },
        { label: "â‰¤ 42", color: "#bbf534" },
        { label: "â‰¤ 44", color: "#fbb938" },
        { label: "â‰¤ 46", color: "#ef5911" },
        { label: "â‰¤ 48", color: "#d43305" },
        { label: "> 48", color: "#7a0403" }
      ]
    });

    map.on("overlayadd", function(e) {
      const layer = layers[e.name];
      if (layer) updateLegend(e.name, layer._legend, layer._isGradient);
    });
  </script>
</body>
</html>
