<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Solar Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .info {
      position: absolute;
      bottom: 20px;
      left: 10px;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background: white;
      padding: 10px;
      font-size: 12px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .legend-color {
      width: 20px;
      height: 12px;
      display: inline-block;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info" id="info">Hover over the map to see values…</div>
  <div class="legend" id="legend">Legend will load with data layer.</div>

  <!-- Dependencies -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>
  <script src="https://unpkg.com/georaster"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

  <script>
    const map = L.map('map').setView([51, -96], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CartoDB'
    }).addTo(map);

    const info = document.getElementById('info');
    const legend = document.getElementById('legend');
    L.Control.geocoder({ defaultMarkGeocode: true })
      .on('markgeocode', function(e) {
        map.setView(e.geocode.center, 12);
      }).addTo(map);

    function updateLegend(title, ranges) {
      legend.innerHTML = `<strong>${title}</strong><br>` + ranges.map(r => `
        <div><span class="legend-color" style="background:${r.color}"></span>${r.label}</div>
      `).join('');
    }

    const layers = {};
    const overlayControl = L.control.layers(null, {}).addTo(map);

    function loadGeoTIFFLayer({ name, url, colorScale, ranges, valueMin, valueMax }) {
      console.log(`🕓 Attempting to load ${name}...`);
      fetch(url)
        .then(r => r.arrayBuffer())
        .then(parseGeoraster)
        .then(georaster => {
          const layer = new GeoRasterLayer({
            georaster,
            opacity: 0.85,
            resolution: 256,
            pixelValuesToColorFn: colorScale
          });

          console.log(`✅ Registered: ${name}`);
          layer._legend = ranges;
          layers[name] = layer;
          overlayControl.addOverlay(layer, name);

          if (Object.keys(layers).length === 1) {
            map.addLayer(layer);
            updateLegend(name, ranges);
          }
        })
        .catch(e => console.error(`❌ Failed to load "${name}" from ${url}`, e));
    }

    // ✅ OGTILT with exact color ranges
    loadGeoTIFFLayer({
      name: "OGTILT",
      url: "https://clebvio.github.io/OGPV/OGTILT.tif",
      valueMin: 29,
      valueMax: 55,
      colorScale: val => {
        if (val <= 30.625) return "rgb(48,18,59)";
        if (val <= 32.25) return "rgb(65,67,167)";
        if (val <= 33.875) return "rgb(71,113,233)";
        if (val <= 35.5) return "rgb(62,156,254)";
        if (val <= 37.125) return "rgb(33,198,225)";
        if (val <= 38.75) return "rgb(27,229,181)";
        if (val <= 40.375) return "rgb(72,248,130)";
        if (val <= 42) return "rgb(137,255,77)";
        if (val <= 43.625) return "rgb(187,245,52)";
        if (val <= 45.25) return "rgb(226,220,56)";
        if (val <= 46.875) return "rgb(251,185,56)";
        if (val <= 48.5) return "rgb(253,139,38)";
        if (val <= 50.125) return "rgb(239,89,17)";
        if (val <= 51.75) return "rgb(212,51,5)";
        if (val <= 53.375) return "rgb(172,23,1)";
        return "rgb(122,4,3)";
      },
      ranges: [
        { label: "≤ 31", color: "#30123b" },
        { label: "31–32", color: "#4143a7" },
        { label: "32–34", color: "#4771e9" },
        { label: "34–36", color: "#3e9cfe" },
        { label: "36–37", color: "#21c6e1" },
        { label: "37–39", color: "#1de5b5" },
        { label: "39–40", color: "#48f882" },
        { label: "40–42", color: "#89ff4d" },
        { label: "42–44", color: "#bbf534" },
        { label: "44–45", color: "#e2dc38" },
        { label: "45–47", color: "#fbb938" },
        { label: "47–49", color: "#fd8b26" },
        { label: "49–50", color: "#ef5911" },
        { label: "50–52", color: "#d43305" },
        { label: "52–53", color: "#ac1701" },
        { label: "> 53", color: "#7a0403" }
      ]
    });

    // ✅ OGIRRI with smooth gradient
    loadGeoTIFFLayer({
      name: "OGIRRI",
      url: "https://clebvio.github.io/OGPV/OGIRRI.tif",
      valueMin: 800,
      valueMax: 1600,
      colorScale: val => {
        if (val === null) return null;
        return chroma.scale(["#ffffff", "#191919", "#4e4e4e", "#6a6a6a", "#7cd2e1", "#93e9e7", "#c7f7c6", "#f8ff8a"])
          .domain([800, 1600])(val).hex();
      },
      ranges: [
        { label: "≤ 923", color: "#191919" },
        { label: "≤ 1170", color: "#4e4e4e" },
        { label: "≤ 1279", color: "#6a6a6a" },
        { label: "≤ 1425", color: "#7cd2e1" },
        { label: "≤ 1490", color: "#93e9e7" },
        { label: "≤ 1588", color: "#c7f7c6" },
        { label: "> 1588", color: "#f8ff8a" }
      ]
    });

    map.on('mousemove', function(e) {
      for (let [name, layer] of Object.entries(layers)) {
        if (!map.hasLayer(layer)) continue;
        if (typeof layer.getValueAtLatLng === 'function') {
          layer.getValueAtLatLng(e.latlng.lat, e.latlng.lng).then(val => {
            if (val && val[0] != null) {
              info.innerHTML = `${name}: <strong>${val[0].toFixed(2)}</strong>`;
            } else {
              info.innerHTML = "No data here…";
            }
          });
        }
      }
    });

    map.on('overlayadd', function(e) {
      const layer = layers[e.name];
      if (layer && layer._legend) updateLegend(e.name, layer._legend);
    });
  </script>
</body>
</html>

